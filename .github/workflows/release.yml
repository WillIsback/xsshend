name: Release

on:
  push:
    tags: [ 'v*' ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # V√©rification de coh√©rence pr√©-release
  pre-release-checks:
    name: Pre-release Consistency Checks
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version-check.outputs.version }}
      tag: ${{ steps.version-check.outputs.tag }}
      is-consistent: ${{ steps.version-check.outputs.is-consistent }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Version consistency check
      id: version-check
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // R√©cup√©rer le tag depuis l'√©v√©nement
          const tag = context.ref.replace('refs/tags/', '');
          const expectedVersion = tag.startsWith('v') ? tag.slice(1) : tag;
          
          console.log(`Tag: ${tag}`);
          console.log(`Expected version: ${expectedVersion}`);
          
          // Lire la version dans Cargo.toml
          const cargoTomlPath = path.join(process.env.GITHUB_WORKSPACE, 'Cargo.toml');
          const cargoToml = fs.readFileSync(cargoTomlPath, 'utf8');
          const cargoVersionMatch = cargoToml.match(/^version\s*=\s*"([^"]+)"/m);
          const cargoVersion = cargoVersionMatch ? cargoVersionMatch[1] : null;
          
          // Lire la version dans main.rs
          const mainRsPath = path.join(process.env.GITHUB_WORKSPACE, 'src', 'main.rs');
          const mainRs = fs.readFileSync(mainRsPath, 'utf8');
          const mainVersionMatch = mainRs.match(/version\s*=\s*"([^"]+)"/);
          const mainVersion = mainVersionMatch ? mainVersionMatch[1] : null;
          
          console.log(`Cargo.toml version: ${cargoVersion}`);
          console.log(`main.rs version: ${mainVersion}`);
          
          // V√©rifier la coh√©rence
          let isConsistent = true;
          let errors = [];
          
          if (!cargoVersion) {
            errors.push('‚ùå Impossible de lire la version dans Cargo.toml');
            isConsistent = false;
          }
          
          if (!mainVersion) {
            errors.push('‚ùå Impossible de lire la version dans src/main.rs');
            isConsistent = false;
          }
          
          if (cargoVersion && cargoVersion !== expectedVersion) {
            errors.push(`‚ùå Version dans Cargo.toml (${cargoVersion}) != tag (${expectedVersion})`);
            isConsistent = false;
          }
          
          if (mainVersion && mainVersion !== expectedVersion) {
            errors.push(`‚ùå Version dans main.rs (${mainVersion}) != tag (${expectedVersion})`);
            isConsistent = false;
          }
          
          if (cargoVersion && mainVersion && cargoVersion !== mainVersion) {
            errors.push(`‚ùå Version Cargo.toml (${cargoVersion}) != main.rs (${mainVersion})`);
            isConsistent = false;
          }
          
          // V√©rifier si la version existe d√©j√† sur crates.io
          try {
            const response = await fetch(`https://crates.io/api/v1/crates/xsshend/${expectedVersion}`);
            if (response.ok) {
              console.log(`‚ö†Ô∏è  Version ${expectedVersion} existe d√©j√† sur crates.io`);
            } else {
              console.log(`‚úÖ Version ${expectedVersion} n'existe pas encore sur crates.io`);
            }
          } catch (error) {
            console.log(`‚ö†Ô∏è  Impossible de v√©rifier crates.io: ${error.message}`);
          }
          
          // V√©rifier si la release GitHub existe d√©j√†
          try {
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tag
            });
            errors.push(`‚ùå Release GitHub ${tag} existe d√©j√† (cr√©√©e le ${release.created_at})`);
            isConsistent = false;
          } catch (error) {
            if (error.status === 404) {
              console.log(`‚úÖ Release GitHub ${tag} n'existe pas encore`);
            } else {
              console.log(`‚ö†Ô∏è  Impossible de v√©rifier la release GitHub: ${error.message}`);
            }
          }
          
          // Afficher le r√©sultat
          if (isConsistent) {
            console.log('‚úÖ Toutes les v√©rifications de coh√©rence sont pass√©es');
            core.summary.addHeading('üéâ V√©rifications de coh√©rence r√©ussies');
            core.summary.addTable([
              ['√âl√©ment', 'Version', 'Status'],
              ['Tag Git', tag, '‚úÖ'],
              ['Cargo.toml', cargoVersion || 'N/A', cargoVersion === expectedVersion ? '‚úÖ' : '‚ùå'],
              ['main.rs', mainVersion || 'N/A', mainVersion === expectedVersion ? '‚úÖ' : '‚ùå']
            ]);
          } else {
            console.log('‚ùå Des incoh√©rences de version ont √©t√© d√©tect√©es:');
            errors.forEach(error => console.log(error));
            
            core.summary.addHeading('‚ùå Incoh√©rences d√©tect√©es');
            core.summary.addList(errors);
            core.summary.addHeading('üîß Actions requises');
            core.summary.addRaw(`
            Pour corriger ces probl√®mes:
            1. Mettez √† jour la version dans \`Cargo.toml\` vers \`${expectedVersion}\`
            2. Mettez √† jour la version dans \`src/main.rs\` vers \`${expectedVersion}\`
            3. Committez les changements
            4. Supprimez et recr√©ez le tag si n√©cessaire
            `);
            
            core.setFailed('Version consistency check failed');
          }
          
          // √âcrire le r√©sum√©
          await core.summary.write();
          
          // D√©finir les outputs
          core.setOutput('version', expectedVersion);
          core.setOutput('tag', tag);
          core.setOutput('is-consistent', isConsistent.toString());
          
          return {
            version: expectedVersion,
            tag: tag,
            isConsistent: isConsistent
          };

  # Tests avant release
  test:
    name: Test before release
    runs-on: ubuntu-latest
    needs: pre-release-checks
    if: needs.pre-release-checks.outputs.is-consistent == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Set up Rust cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

    - name: Run tests
      run: cargo test --verbose

    - name: Build release
      run: cargo build --release --verbose

    - name: Run release binary test
      run: |
        ./target/release/xsshend --version
        ./target/release/xsshend --help

  # Build multi-platform
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    needs: [pre-release-checks, test]
    if: needs.pre-release-checks.outputs.is-consistent == 'true'
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            suffix: ""
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            suffix: ""
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            suffix: ".exe"
          - os: macos-latest
            target: x86_64-apple-darwin
            suffix: ""
          - os: macos-latest
            target: aarch64-apple-darwin
            suffix: ""

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install musl tools (Linux musl only)
      if: matrix.target == 'x86_64-unknown-linux-musl'
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools

    - name: Set up Rust cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build release binary
      run: cargo build --release --target ${{ matrix.target }} --verbose

    - name: Create archive
      shell: bash
      run: |
        ARCHIVE_NAME="xsshend-${{ needs.pre-release-checks.outputs.version }}-${{ matrix.target }}"
        BINARY_PATH="target/${{ matrix.target }}/release/xsshend${{ matrix.suffix }}"
        
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          7z a "${ARCHIVE_NAME}.zip" "${BINARY_PATH}"
          echo "ARCHIVE=${ARCHIVE_NAME}.zip" >> $GITHUB_ENV
        else
          tar czf "${ARCHIVE_NAME}.tar.gz" -C "target/${{ matrix.target }}/release" "xsshend${{ matrix.suffix }}"
          echo "ARCHIVE=${ARCHIVE_NAME}.tar.gz" >> $GITHUB_ENV
        fi

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.target }}
        path: ${{ env.ARCHIVE }}

  # Publication sur crates.io
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: [pre-release-checks, build]
    if: needs.pre-release-checks.outputs.is-consistent == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Set up Rust cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ubuntu-latest-cargo-publish-${{ hashFiles('**/Cargo.lock') }}

    - name: Publish to crates.io
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: |
        echo "Publishing xsshend version ${{ needs.pre-release-checks.outputs.version }} to crates.io..."
        cargo publish --verbose

  # D√©ploiement de la documentation GitHub Pages
  deploy-docs:
    name: Deploy Documentation to GitHub Pages
    runs-on: ubuntu-latest
    needs: [pre-release-checks, publish]
    if: needs.pre-release-checks.outputs.is-consistent == 'true'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Pages
      uses: actions/configure-pages@v3
    
    - name: Build documentation with Jekyll
      uses: actions/jekyll-build-pages@v1
      with:
        source: ./docs
        destination: ./_site
    
    - name: Upload artifact to Pages
      uses: actions/upload-pages-artifact@v2
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

  # Cr√©ation de la release GitHub
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [pre-release-checks, build, publish, deploy-docs]
    if: needs.pre-release-checks.outputs.is-consistent == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Prepare release assets
      run: |
        mkdir -p release-assets/
        find artifacts/ -name "*.tar.gz" -o -name "*.zip" | while read file; do
          cp "$file" release-assets/
        done
        ls -la release-assets/

    - name: Generate release notes
      id: release-notes
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Lire les notes de release depuis RELEASE_NOTES_v0.2.2.md si elles existent
          const releaseNotesPath = path.join(process.env.GITHUB_WORKSPACE, 'RELEASE_NOTES_${{ needs.pre-release-checks.outputs.tag }}.md');
          let releaseBody = '';
          
          if (fs.existsSync(releaseNotesPath)) {
            releaseBody = fs.readFileSync(releaseNotesPath, 'utf8');
            console.log('‚úÖ Release notes trouv√©es dans le fichier local');
          } else {
            // G√©n√©rer des notes automatiques
            releaseBody = `## xsshend ${{ needs.pre-release-checks.outputs.version }}

            ### üöÄ Nouvelle version

            Cette release contient les derni√®res am√©liorations et corrections de bugs pour xsshend.

            ### üì¶ T√©l√©chargements

            Choisissez le binaire correspondant √† votre syst√®me :

            - **Linux x86_64**: \`xsshend-${{ needs.pre-release-checks.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz\`
            - **Linux x86_64 (musl)**: \`xsshend-${{ needs.pre-release-checks.outputs.version }}-x86_64-unknown-linux-musl.tar.gz\`
            - **Windows x86_64**: \`xsshend-${{ needs.pre-release-checks.outputs.version }}-x86_64-pc-windows-msvc.zip\`
            - **macOS x86_64**: \`xsshend-${{ needs.pre-release-checks.outputs.version }}-x86_64-apple-darwin.tar.gz\`
            - **macOS ARM64**: \`xsshend-${{ needs.pre-release-checks.outputs.version }}-aarch64-apple-darwin.tar.gz\`

            ### üìã Installation

            \`\`\`bash
            # Avec cargo
            cargo install xsshend

            # Ou t√©l√©chargez le binaire et ajoutez-le √† votre PATH
            \`\`\`

            ### üîó Liens utiles

            - üìö [Documentation](https://docs.rs/xsshend)
            - üì¶ [crates.io](https://crates.io/crates/xsshend)
            - üêõ [Signaler un bug](https://github.com/${{ github.repository }}/issues)

            ---
            *G√©n√©r√© automatiquement le $(date)*`;
            
            console.log('üìù Notes de release g√©n√©r√©es automatiquement');
          }
          
          core.setOutput('body', releaseBody);
          return releaseBody;

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.pre-release-checks.outputs.tag }}
        name: xsshend ${{ needs.pre-release-checks.outputs.version }}
        body: ${{ steps.release-notes.outputs.body }}
        draft: false
        prerelease: false
        files: release-assets/*
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Post-release verification
      uses: actions/github-script@v7
      with:
        script: |
          console.log('üéâ Release cr√©√©e avec succ√®s !');
          
          // V√©rifier crates.io
          const version = '${{ needs.pre-release-checks.outputs.version }}';
          try {
            const response = await fetch(`https://crates.io/api/v1/crates/xsshend/${version}`);
            if (response.ok) {
              console.log(`‚úÖ Version ${version} disponible sur crates.io`);
            } else {
              console.log(`‚ö†Ô∏è  Version ${version} pas encore disponible sur crates.io (peut prendre quelques minutes)`);
            }
          } catch (error) {
            console.log(`‚ùå Erreur lors de la v√©rification crates.io: ${error.message}`);
          }
          
          // Cr√©er un r√©sum√© final
          core.summary.addHeading('üéâ Release ${{ needs.pre-release-checks.outputs.tag }} cr√©√©e avec succ√®s');
          core.summary.addTable([
            ['√âl√©ment', 'Status', 'Lien'],
            ['GitHub Release', '‚úÖ Cr√©√©e', `https://github.com/${{ github.repository }}/releases/tag/${{ needs.pre-release-checks.outputs.tag }}`],
            ['crates.io', '‚è≥ En cours', `https://crates.io/crates/xsshend/${version}`],
            ['Documentation API', '‚è≥ En cours', `https://docs.rs/xsshend/${version}`],
            ['Documentation Web', '‚úÖ D√©ploy√©e', `https://willisback.github.io/xsshend/`]
          ]);
          
          await core.summary.write();

  # Nettoyage des artefacts
  cleanup:
    name: Cleanup artifacts
    runs-on: ubuntu-latest
    needs: [release]
    if: always()
    
    steps:
    - name: Delete build artifacts
      uses: geekyeggo/delete-artifact@v4
      with:
        name: |
          x86_64-unknown-linux-gnu
          x86_64-unknown-linux-musl
          x86_64-pc-windows-msvc
          x86_64-apple-darwin
          aarch64-apple-darwin
